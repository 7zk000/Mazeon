# ReactNative ゲーム開発 注意点（絶対遵守）

本ドキュメントは、ReactNativeでゲームを開発する際に“必ず守る”べきベストプラクティスをまとめたものです。詳細な解説や実装例は `backend/DevDocuments/dev.md`（開発ドキュメント）および `backend/DevDocuments/ReactNativeGameDevelopment.md`（補足資料）を参照してください（存在する場合）。

## 1. パフォーマンス・スレッド管理
- [必須] アニメーションは `react-native-reanimated` を使用し、UIスレッドで実行する
- [必須] 重い計算（経路探索・迷路生成など）はUIスレッドをブロックしない（分割実行・ワーカー・バックエンド委譲）
- [必須] 大量描画は `FlatList`/`SectionList` を使用し、`keyExtractor` を安定化
- [必須] 再レンダリング抑制に `React.memo`/`useMemo`/`useCallback` を徹底
- [必須] 画像・音声は事前読み込み（プリロード）し、未使用時は解放（`release()`）

## 2. 状態管理・データフロー
- [必須] グローバル状態はContextや適切な状態管理（必要に応じてReducer）を使用。安易な多重Context値の無秩序更新は禁止
- [必須] ネストの深い状態は避け、正規化（フラット化）して更新粒度を最小化
- [必須] ソケット通信（Socket.IO）は単一接続を集中管理し、イベント購読/解除を `useEffect` のクリーンアップで厳守
- [必須] ゲームループは `requestAnimationFrame` を用い、フレームごとに最小限の更新に限定

## 3. ネットワーク・同期
- [必須] サーバとのプロトコルはイベント名・ペイロードを `constants` に定義して両端で共有
- [必須] 楽観更新は可能でも、サーバ真実源（SSOT）で最終確定。矛盾時はロールバック
- [必須] 通信エラー/再接続戦略（指数バックオフ・最大試行回数）を実装

## 4. リソース・アセット
- [必須] 画像/音声は `src/assets/` 配下の規約に従い配置。命名規則・サイズ・圧縮方針を厳守
- [必須] 大容量アセットの同時読み込みを避け、画面単位で遅延ロード
- [必須] 使用後は明示的に解放（音声 `release()`、タイマー/リスナー `clear`/`remove`）

## 5. エラーハンドリング・ログ
- [必須] すべての非同期処理に `try/catch` とユーザ向けメッセージ、開発者向けログを付与
- [必須] ログレベル（error/warn/info/debug）を `GameConfig` で集中管理し、本番では冗長ログを無効化
- [必須] クリティカルな失敗（接続不可・破損データ）は復旧フロー（再試行/初期化）を提供

## 6. UI/UX・操作
- [必須] タップ領域・可読性はスケーリング関数で端末差を吸収（`scaledSize`）
- [必須] ジェスチャーは `react-native-gesture-handler` を使用し、競合を整理
- [必須] フレーム落ちや入力遅延を招く同期処理をUIスレッドに置かない

## 7. セキュリティ・設定
- [必須] 機密値は `.env`（例: `backend/env.example` を参照）で管理し、リポジトリに直書きしない
- [必須] APIエンドポイント/ソケットURLは `GameConfig.network` に集約し、環境ごとに切替
- [必須] 信頼できない入力は検証・サニタイズ、サーバ側でも再検証

## 8. テスト・検証
- [必須] 主要ロジック（移動判定/衝突/タイマー）はユニットテストを用意
- [必須] 低性能端末・長時間プレイでメモリリーク/発熱/電池消費を確認
- [必須] ビルド前に型/リンタ/テストを実行し、警告/エラー0を維持

## 9. メンテナンス・拡張
- [必須] 新規機能は `config/constants/utils/services/hooks/components` の責務分離に従う
- [必須] 既存の共通関数・設定に準拠し、重複実装を避ける（再利用優先）
- [必須] ドキュメント（このファイル・`dev.md`）を更新し、変更点を必ず明記

---

更新時は `backend/DevDocuments/dev.md` の「AI更新ルール」を遵守してください。関連資料として `src/config/GameConfig.js`、`src/constants/GameConstants.js`、`src/utils/GameUtils.js` も参照のこと。